<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <title>Den</title>
  <link rel="stylesheet" href="/vendor/xterm.css">
  <link rel="stylesheet" href="/css/style.css">
</head>
<body>
  <!-- ログイン画面 -->
  <div id="login-screen" class="screen">
    <div class="login-box">
      <h1>Den</h1>
      <p class="login-subtitle">Personal Workstation</p>
      <form id="login-form">
        <input type="password" id="password-input" placeholder="Password" autocomplete="current-password">
        <button type="submit">Enter</button>
      </form>
      <p id="login-error" class="error" hidden>Incorrect password</p>
    </div>
  </div>

  <!-- メイン画面 -->
  <div id="main-screen" class="screen" hidden data-1p-ignore>
    <!-- タブバー -->
    <div id="tab-bar" role="tablist" aria-label="Main navigation">
      <button class="tab active" data-tab="terminal" role="tab" aria-selected="true">Terminal</button>
      <button class="tab" data-tab="filer" role="tab" aria-selected="false">Files</button>
      <div class="tab-spacer"></div>
      <button id="clipboard-history-btn" class="tab-icon-btn" data-tooltip="Clipboard History" aria-label="Clipboard history"></button>
      <button id="snippet-btn" class="tab-icon-btn" data-tooltip="Snippets" aria-label="Snippets"></button>
      <button id="float-terminal-btn" class="tab-icon-btn" data-tooltip="Floating Terminal (Ctrl+`)" aria-label="Floating terminal"></button>
      <button id="settings-btn" class="tab-icon-btn" data-tooltip="Settings" aria-label="Settings"></button>
    </div>

    <!-- ターミナル -->
    <div id="terminal-pane" class="pane" role="tabpanel" aria-label="Terminal">
      <div id="terminal-session-bar" class="terminal-session-bar">
        <div id="session-tabs" class="session-tabs" role="tablist" aria-label="Terminal sessions"></div>
        <button id="session-new-btn" class="session-bar-btn" data-tooltip="New Session" aria-label="New session">+</button>
        <span id="session-clients" class="session-clients" aria-hidden="true"></span>
      </div>
      <div id="terminal-container"></div>
    </div>

    <!-- ファイラ -->
    <div id="filer-pane" class="pane" hidden role="tabpanel" aria-label="Files">
      <div class="filer-layout">
        <!-- サイドバー: ツリービュー -->
        <div class="filer-sidebar">
          <button class="sidebar-toggle filer-sidebar-toggle" data-tooltip="Toggle Sidebar" aria-label="Toggle sidebar"></button>
          <div class="filer-toolbar">
            <button id="filer-new-file" class="filer-tool-btn" data-tooltip="New File" aria-label="New file"></button>
            <button id="filer-new-folder" class="filer-tool-btn" data-tooltip="New Folder" aria-label="New folder"></button>
            <button id="filer-upload" class="filer-tool-btn" data-tooltip="Upload" aria-label="Upload file"></button>
            <button id="filer-refresh" class="filer-tool-btn" data-tooltip="Refresh" aria-label="Refresh tree"></button>
            <button id="filer-remote-btn" class="filer-tool-btn filer-remote-btn" data-tooltip="Connect to remote SFTP" aria-label="Remote SFTP">Remote</button>
          </div>
          <div id="filer-drives" class="dir-drives"></div>
          <nav id="filer-breadcrumb" class="filer-breadcrumb" aria-label="Current path"></nav>
          <div class="filer-search">
            <input type="text" id="filer-search-input" placeholder="Search files..." aria-label="Search files" />
          </div>
          <div id="filer-tree" class="filer-tree" role="tree" aria-label="File tree"></div>
        </div>
        <!-- メインエリア: エディタ -->
        <div class="filer-main">
          <div class="filer-tabs-wrapper">
            <button id="filer-tree-toggle" class="filer-tree-toggle" data-tooltip="Toggle Tree" aria-label="Toggle file tree"></button>
            <button id="filer-tree-side" class="filer-tree-toggle" data-tooltip="Move Tree Right/Left" aria-label="Move tree to other side"></button>
            <button class="filer-tabs-scroll left" hidden data-tooltip="Scroll Left" aria-label="Scroll tabs left"></button>
            <div id="filer-tabs" class="filer-tabs" role="tablist" aria-label="Open files"></div>
            <button class="filer-tabs-scroll right" hidden data-tooltip="Scroll Right" aria-label="Scroll tabs right"></button>
            <button id="filer-md-preview-toggle" class="filer-tool-btn filer-tree-toggle" hidden data-tooltip="Toggle Preview" aria-label="Toggle Markdown preview"></button>
          </div>
          <div id="filer-editor" class="filer-editor">
            <div class="filer-welcome">
              <p>Select a file to edit</p>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- アップロードモーダル -->
    <div id="filer-upload-modal" class="modal" hidden role="dialog" aria-modal="true" aria-label="Upload file">
      <div class="modal-content">
        <h3>Upload File</h3>
        <div class="modal-section">
          <label>Destination</label>
          <input type="text" id="upload-dest" class="settings-input" readonly />
        </div>
        <div class="modal-section">
          <label>File</label>
          <input type="file" id="upload-file-input" />
        </div>
        <div class="modal-actions">
          <button id="upload-cancel" class="modal-btn">Cancel</button>
          <button id="upload-submit" class="modal-btn primary">Upload</button>
        </div>
      </div>
    </div>

    <!-- 検索結果モーダル -->
    <div id="filer-search-modal" class="modal" hidden role="dialog" aria-modal="true" aria-label="Search results">
      <div class="modal-content modal-content-wide">
        <h3>Search Results</h3>
        <div id="filer-search-results" class="filer-search-results"></div>
        <div class="modal-actions">
          <button id="search-close" class="modal-btn">Close</button>
        </div>
      </div>
    </div>

    <!-- クイックオープンモーダル -->
    <div id="filer-quickopen-modal" class="modal" hidden role="dialog" aria-modal="true" aria-label="Quick open">
      <div class="modal-content modal-content-wide">
        <input type="text" id="quickopen-input" class="quickopen-input" placeholder="File name..." autocomplete="off" />
        <div id="quickopen-results" class="quickopen-results"></div>
      </div>
    </div>

    <!-- SFTP 接続モーダル -->
    <div id="sftp-connect-modal" class="modal" hidden role="dialog" aria-modal="true" aria-label="SFTP Connection">
      <div class="modal-content">
        <h3>Remote SFTP Connection</h3>
        <div class="modal-section">
          <label>Host</label>
          <input type="text" id="sftp-host" class="settings-input" placeholder="hostname or IP" autocomplete="off" />
        </div>
        <div class="modal-section">
          <label>Port</label>
          <input type="number" id="sftp-port" class="settings-input" value="22" min="1" max="65535" />
        </div>
        <div class="modal-section">
          <label>Username</label>
          <input type="text" id="sftp-username" class="settings-input" placeholder="username" autocomplete="off" />
        </div>
        <div class="modal-section">
          <label>Authentication</label>
          <select id="sftp-auth-type" class="settings-input">
            <option value="password">Password</option>
            <option value="key">Private Key</option>
          </select>
        </div>
        <div class="modal-section" id="sftp-password-field">
          <label>Password</label>
          <input type="password" id="sftp-password" class="settings-input" autocomplete="off" />
        </div>
        <div class="modal-section" id="sftp-key-field" hidden>
          <label>Key File Path</label>
          <input type="text" id="sftp-key-path" class="settings-input" placeholder="~/.ssh/id_rsa" autocomplete="off" />
        </div>
        <div class="modal-actions">
          <button id="sftp-connect-cancel" class="modal-btn">Cancel</button>
          <button id="sftp-connect-submit" class="modal-btn primary">Connect</button>
        </div>
      </div>
    </div>

    <!-- 設定モーダル -->
    <div id="settings-modal" class="modal" hidden role="dialog" aria-modal="true" aria-label="Settings">
      <div class="modal-content">
        <h3>Settings</h3>
        <div class="modal-section">
          <label>Theme</label>
          <select id="setting-theme" class="settings-input">
            <option value="dark">Dark</option>
            <option value="light">Light</option>
            <option value="solarized-dark">Solarized Dark</option>
            <option value="solarized-light">Solarized Light</option>
            <option value="monokai">Monokai</option>
            <option value="nord">Nord</option>
            <option value="dracula">Dracula</option>
            <option value="gruvbox-dark">Gruvbox Dark</option>
            <option value="gruvbox-light">Gruvbox Light</option>
            <option value="catppuccin">Catppuccin Mocha</option>
            <option value="one-dark">One Dark</option>
            <option value="system">System</option>
          </select>
        </div>
        <div class="modal-section">
          <label>Font Size</label>
          <input type="number" id="setting-font-size" class="settings-input" min="8" max="32" value="14">
        </div>
        <div class="modal-section">
          <label>Terminal Scrollback</label>
          <input type="number" id="setting-scrollback" class="settings-input" min="100" max="50000" value="1000">
        </div>
        <div class="modal-section">
          <label>
            <input type="checkbox" id="setting-ssh-agent-fwd">
            SSH Agent Forwarding
          </label>
          <small class="setting-hint">Forward local SSH keys to remote hosts (security risk on untrusted hosts)</small>
        </div>
        <div class="modal-section">
          <label>Sleep Prevention</label>
          <select id="setting-sleep-mode" class="settings-input">
            <option value="user-activity">After user activity (default)</option>
            <option value="always">Always (while Den is running)</option>
            <option value="off">Off</option>
          </select>
          <small class="setting-hint">Prevent system sleep while terminal is in use (Windows only)</small>
          <div id="sleep-timeout-row" style="margin-top:0.5rem">
            <label>Timeout (minutes)</label>
            <input type="number" id="setting-sleep-timeout" class="settings-input" min="1" max="480" value="30">
          </div>
        </div>
        <div class="modal-section">
          <label>Keybar Buttons - Primary Row</label>
          <div id="keybar-editor" class="keybar-editor">
            <div id="keybar-btn-list" class="keybar-btn-list"></div>
            <div class="keybar-editor-actions">
              <button id="keybar-add-btn" class="modal-btn" type="button">Add Button</button>
              <button id="keybar-reset-btn" class="modal-btn" type="button">Reset to Default</button>
            </div>
            <div id="keybar-add-form" class="keybar-add-form" hidden>
              <div class="keybar-form-row">
                <label>Type</label>
                <select id="keybar-new-type" class="settings-input">
                  <option value="single">Single Key</option>
                  <option value="stack">Stack (long-press to switch)</option>
                </select>
              </div>
              <!-- Single key fields -->
              <div id="keybar-single-fields">
                <div class="keybar-form-row">
                  <label>Label</label>
                  <input type="text" id="keybar-new-label" class="settings-input" placeholder="e.g. Tab" maxlength="8">
                </div>
                <div class="keybar-form-row">
                  <label>Send</label>
                  <select id="keybar-preset-select" class="settings-input">
                    <option value="">-- Custom --</option>
                  </select>
                  <input type="text" id="keybar-new-send" class="settings-input" placeholder="e.g. \t or literal text">
                </div>
                <div class="keybar-form-row">
                  <label>
                    <input type="checkbox" id="keybar-new-modifier"> Modifier key (Ctrl/Alt/Shift)
                  </label>
                  <select id="keybar-new-modkey" class="settings-input" hidden>
                    <option value="ctrl">Ctrl</option>
                    <option value="alt">Alt</option>
                    <option value="shift">Shift</option>
                  </select>
                </div>
              </div>
              <!-- Stack fields -->
              <div id="keybar-stack-fields" hidden>
                <div id="keybar-stack-items" class="keybar-stack-items"></div>
                <div class="keybar-form-row">
                  <select id="keybar-stack-preset" class="settings-input">
                    <option value="">-- Select or custom --</option>
                  </select>
                </div>
                <div class="keybar-form-row">
                  <input type="text" id="keybar-stack-item-label" class="settings-input" placeholder="Label" maxlength="8">
                  <input type="text" id="keybar-stack-item-send" class="settings-input" placeholder="Send (e.g. \x03)">
                  <button id="keybar-stack-add-item" class="modal-btn" type="button">+</button>
                </div>
              </div>
              <div class="keybar-form-actions">
                <button id="keybar-add-confirm" class="modal-btn primary" type="button">Add</button>
                <button id="keybar-add-cancel" class="modal-btn" type="button">Cancel</button>
              </div>
            </div>
          </div>
        </div>
        <div class="modal-section">
          <label>Keybar Buttons - Secondary Row</label>
          <div id="keybar-secondary-editor" class="keybar-editor">
            <div id="keybar-secondary-btn-list" class="keybar-btn-list"></div>
            <div class="keybar-editor-actions">
              <button id="keybar-secondary-add-btn" class="modal-btn" type="button">Add Button</button>
              <button id="keybar-secondary-reset-btn" class="modal-btn" type="button">Reset to Default</button>
            </div>
          </div>
        </div>
        <div class="modal-section">
          <label>Snippets</label>
          <div class="snippet-editor">
            <div id="snippet-list" class="snippet-list"></div>
            <div class="keybar-editor-actions">
              <button id="snippet-add-btn" class="modal-btn" type="button">Add Snippet</button>
            </div>
            <div id="snippet-add-form" class="snippet-add-form" hidden>
              <div class="keybar-form-row">
                <label>Label</label>
                <input type="text" id="snippet-new-label" class="settings-input" placeholder="e.g. workspace" maxlength="20">
              </div>
              <div class="keybar-form-row">
                <label>Command</label>
                <textarea id="snippet-new-command" class="snippet-textarea" placeholder="e.g. cd d:\workspace / \r~s (supports \r \n \t \x##)" rows="2"></textarea>
              </div>
              <div class="keybar-form-row">
                <label>
                  <input type="checkbox" id="snippet-new-autorun"> Auto-run (execute immediately)
                </label>
              </div>
              <div class="keybar-form-actions">
                <button id="snippet-add-confirm" class="modal-btn primary" type="button">Add</button>
                <button id="snippet-add-cancel" class="modal-btn" type="button">Cancel</button>
              </div>
            </div>
          </div>
        </div>
        <div class="settings-version" id="settings-version"></div>
        <div class="modal-actions">
          <button id="settings-cancel" class="modal-btn">Cancel</button>
          <button id="settings-save" class="modal-btn primary">Save</button>
        </div>
      </div>
    </div>

    <!-- フローティングターミナル -->
    <div id="float-terminal" class="float-terminal" hidden role="region" aria-label="Floating terminal">
      <div class="float-terminal-header">
        <select class="float-session-select session-select" aria-label="Session"></select>
        <button class="float-session-new session-bar-btn" data-tooltip="New Session" aria-label="New session">+</button>
        <span class="float-session-clients session-clients"></span>
        <div class="float-header-spacer"></div>
        <button class="float-session-kill session-bar-btn danger" data-tooltip="Kill Session" aria-label="Kill session">x</button>
        <button class="float-minimize session-bar-btn" data-tooltip="Minimize" aria-label="Minimize">_</button>
        <button class="float-close session-bar-btn" data-tooltip="Close" aria-label="Close">X</button>
      </div>
      <div class="float-terminal-body"></div>
      <div class="float-resize" data-dir="n"></div>
      <div class="float-resize" data-dir="s"></div>
      <div class="float-resize" data-dir="e"></div>
      <div class="float-resize" data-dir="w"></div>
      <div class="float-resize" data-dir="ne"></div>
      <div class="float-resize" data-dir="nw"></div>
      <div class="float-resize" data-dir="se"></div>
      <div class="float-resize" data-dir="sw"></div>
    </div>
    <button id="float-terminal-restore" class="float-terminal-restore" hidden aria-label="Restore floating terminal">Terminal</button>

    <!-- キーバー (フローティング) -->
    <div id="keybar" hidden role="toolbar" aria-label="Keyboard bar">
      <div class="keybar-drag-handle" aria-hidden="true">&#x2807;</div>
      <div class="keybar-content">
        <div class="keybar-row keybar-primary">
          <div class="keybar-buttons"></div>
          <button type="button" class="keybar-secondary-toggle" aria-label="Toggle secondary row" hidden>&#x25BC;</button>
          <button type="button" class="keybar-collapse-btn" aria-label="Collapse">&minus;</button>
        </div>
        <div class="keybar-row keybar-secondary" hidden>
          <div class="keybar-buttons-secondary"></div>
        </div>
      </div>
    </div>
    <button type="button" id="keybar-tab" class="keybar-tab" data-side="right" hidden aria-label="Show keyboard bar">&#x2328;</button>
  </div>

  <script src="/vendor/codemirror.js"></script>
  <script src="/vendor/xterm.js"></script>
  <script src="/vendor/xterm-addon-fit.js"></script>
  <script src="/vendor/xterm-addon-webgl.js"></script>
  <script src="/js/icons.js"></script>
  <script src="/js/toast.js"></script>
  <script src="/js/clipboard.js"></script>
  <script src="/js/clipboard-history.js"></script>
  <script src="/js/spinner.js"></script>
  <script src="/js/auth.js"></script>
  <script src="/js/settings-drag-list.js"></script>
  <script src="/js/settings-presets.js"></script>
  <script src="/js/settings.js"></script>
  <script src="/js/terminal.js"></script>
  <script src="/js/snippet.js"></script>
  <script src="/js/float-terminal.js"></script>
  <script src="/js/keybar.js"></script>
  <script src="/js/markdown.js"></script>
  <script src="/js/filer-remote.js"></script>
  <script src="/js/filer-tree.js"></script>
  <script src="/js/filer-editor.js"></script>
  <script src="/js/filer.js"></script>
  <script src="/js/app.js"></script>
</body>
</html>
